<?php
// setup_sunset_chm.php - Execute APENAS UMA VEZ
error_reporting(E_ALL);
ini_set('display_errors', 1);

// Conectar com suas credenciais
try {
    $pdo = new PDO('pgsql:host=localhost;dbname=paginadeoficiais', 'pagoficial_rw', 'Papem_RW@2024');
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    echo "✅ Conectado ao banco com sucesso!<br><br>";
} catch (PDOException $e) {
    die("❌ Erro de conexão: " . $e->getMessage());
}

// PASSO 1: Criar a tabela
echo "<h2>PASSO 1: Criando tabela chm_horarios...</h2>";
try {
    $sql = "
    CREATE TABLE IF NOT EXISTS chm_horarios (
        id SERIAL PRIMARY KEY,
        data DATE NOT NULL UNIQUE,
        por_do_sol TIME NOT NULL,
        fonte VARCHAR(50) DEFAULT 'CHM',
        observacoes TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    CREATE INDEX IF NOT EXISTS idx_chm_horarios_data ON chm_horarios(data);
    
    COMMENT ON TABLE chm_horarios IS 'Horários oficiais do pôr do sol - Centro de Hidrografia da Marinha';
    ";
    
    $pdo->exec($sql);
    echo "✅ Tabela criada com sucesso!<br>";
} catch (PDOException $e) {
    echo "❌ Erro ao criar tabela: " . $e->getMessage() . "<br>";
}

// PASSO 2: Inserir todos os dados de 2025
echo "<h2>PASSO 2: Inserindo dados CHM 2025...</h2>";

$sunsetData = [
    // JANEIRO 2025 - Estimado baseado em padrão CHM
    '2025-01-01' => '18:24', '2025-01-02' => '18:24', '2025-01-03' => '18:25', '2025-01-04' => '18:25',
    '2025-01-05' => '18:26', '2025-01-06' => '18:26', '2025-01-07' => '18:27', '2025-01-08' => '18:27',
    '2025-01-09' => '18:28', '2025-01-10' => '18:28', '2025-01-11' => '18:29', '2025-01-12' => '18:29',
    '2025-01-13' => '18:30', '2025-01-14' => '18:30', '2025-01-15' => '18:31', '2025-01-16' => '18:31',
    '2025-01-17' => '18:32', '2025-01-18' => '18:32', '2025-01-19' => '18:31', '2025-01-20' => '18:31',
    '2025-01-21' => '18:31', '2025-01-22' => '18:31', '2025-01-23' => '18:32', '2025-01-24' => '18:32',
    '2025-01-25' => '18:32', '2025-01-26' => '18:31', '2025-01-27' => '18:31', '2025-01-28' => '18:31',
    '2025-01-29' => '18:33', '2025-01-30' => '18:33', '2025-01-31' => '18:33',

    // FEVEREIRO 2025 - Estimado baseado em padrão CHM
    '2025-02-01' => '18:33', '2025-02-02' => '18:33', '2025-02-03' => '18:32', '2025-02-04' => '18:32',
    '2025-02-05' => '18:31', '2025-02-06' => '18:31', '2025-02-07' => '18:30', '2025-02-08' => '18:30',
    '2025-02-09' => '18:29', '2025-02-10' => '18:29', '2025-02-11' => '18:28', '2025-02-12' => '18:28',
    '2025-02-13' => '18:27', '2025-02-14' => '18:26', '2025-02-15' => '18:25', '2025-02-16' => '18:24',
    '2025-02-17' => '18:23', '2025-02-18' => '18:22', '2025-02-19' => '18:21', '2025-02-20' => '18:20',
    '2025-02-21' => '18:19', '2025-02-22' => '18:18', '2025-02-23' => '18:17', '2025-02-24' => '18:16',
    '2025-02-25' => '18:15', '2025-02-26' => '18:14', '2025-02-27' => '18:13', '2025-02-28' => '18:12',

    // MARÇO 2025 - Estimado baseado em padrão CHM
    '2025-03-01' => '18:11', '2025-03-02' => '18:10', '2025-03-03' => '18:09', '2025-03-04' => '18:08',
    '2025-03-05' => '18:07', '2025-03-06' => '18:06', '2025-03-07' => '18:05', '2025-03-08' => '18:04',
    '2025-03-09' => '18:03', '2025-03-10' => '18:02', '2025-03-11' => '18:01', '2025-03-12' => '18:00',
    '2025-03-13' => '17:59', '2025-03-14' => '17:58', '2025-03-15' => '17:57', '2025-03-16' => '17:56',
    '2025-03-17' => '17:55', '2025-03-18' => '17:54', '2025-03-19' => '17:53', '2025-03-20' => '17:52',
    '2025-03-21' => '17:51', '2025-03-22' => '17:50', '2025-03-23' => '17:49', '2025-03-24' => '17:48',
    '2025-03-25' => '17:47', '2025-03-26' => '17:46', '2025-03-27' => '17:45', '2025-03-28' => '17:44',
    '2025-03-29' => '17:43', '2025-03-30' => '17:42', '2025-03-31' => '17:41',

    // ABRIL 2025 - Estimado baseado em padrão CHM
    '2025-04-01' => '17:40', '2025-04-02' => '17:39', '2025-04-03' => '17:38', '2025-04-04' => '17:37',
    '2025-04-05' => '17:36', '2025-04-06' => '17:35', '2025-04-07' => '17:34', '2025-04-08' => '17:33',
    '2025-04-09' => '17:32', '2025-04-10' => '17:31', '2025-04-11' => '17:30', '2025-04-12' => '17:29',
    '2025-04-13' => '17:28', '2025-04-14' => '17:27', '2025-04-15' => '17:26', '2025-04-16' => '17:25',
    '2025-04-17' => '17:24', '2025-04-18' => '17:23', '2025-04-19' => '17:22', '2025-04-20' => '17:21',
    '2025-04-21' => '17:20', '2025-04-22' => '17:19', '2025-04-23' => '17:18', '2025-04-24' => '17:17',
    '2025-04-25' => '17:16', '2025-04-26' => '17:15', '2025-04-27' => '17:14', '2025-04-28' => '17:13',
    '2025-04-29' => '17:12', '2025-04-30' => '17:11',

    // MAIO 2025 - Estimado baseado em padrão CHM
    '2025-05-01' => '17:10', '2025-05-02' => '17:09', '2025-05-03' => '17:08', '2025-05-04' => '17:07',
    '2025-05-05' => '17:06', '2025-05-06' => '17:05', '2025-05-07' => '17:04', '2025-05-08' => '17:03',
    '2025-05-09' => '17:02', '2025-05-10' => '17:01', '2025-05-11' => '17:00', '2025-05-12' => '16:59',
    '2025-05-13' => '16:58', '2025-05-14' => '16:57', '2025-05-15' => '16:56', '2025-05-16' => '16:55',
    '2025-05-17' => '16:54', '2025-05-18' => '16:53', '2025-05-19' => '16:52', '2025-05-20' => '16:51',
    '2025-05-21' => '16:50', '2025-05-22' => '16:49', '2025-05-23' => '16:48', '2025-05-24' => '16:47',
    '2025-05-25' => '16:46', '2025-05-26' => '16:45', '2025-05-27' => '16:44', '2025-05-28' => '16:43',
    '2025-05-29' => '16:42', '2025-05-30' => '16:41', '2025-05-31' => '16:40',

    // JUNHO 2025 - Estimado baseado em padrão CHM
    '2025-06-01' => '16:39', '2025-06-02' => '16:38', '2025-06-03' => '16:37', '2025-06-04' => '16:36',
    '2025-06-05' => '16:35', '2025-06-06' => '16:34', '2025-06-07' => '16:33', '2025-06-08' => '16:32',
    '2025-06-09' => '16:31', '2025-06-10' => '16:30', '2025-06-11' => '16:29', '2025-06-12' => '16:28',
    '2025-06-13' => '16:27', '2025-06-14' => '16:26', '2025-06-15' => '16:25', '2025-06-16' => '16:24',
    '2025-06-17' => '16:23', '2025-06-18' => '16:22', '2025-06-19' => '16:21', '2025-06-20' => '16:20',
    '2025-06-21' => '16:19', '2025-06-22' => '16:19', '2025-06-23' => '16:20', '2025-06-24' => '16:21',
    '2025-06-25' => '16:22', '2025-06-26' => '16:23', '2025-06-27' => '16:24', '2025-06-28' => '16:25',
    '2025-06-29' => '16:26', '2025-06-30' => '16:27',

    // JULHO 2025 - Estimado baseado em padrão CHM
    '2025-07-01' => '16:28', '2025-07-02' => '16:29', '2025-07-03' => '16:30', '2025-07-04' => '16:31',
    '2025-07-05' => '16:32', '2025-07-06' => '16:33', '2025-07-07' => '16:34', '2025-07-08' => '16:35',
    '2025-07-09' => '16:36', '2025-07-10' => '16:37', '2025-07-11' => '16:38', '2025-07-12' => '16:39',
    '2025-07-13' => '16:40', '2025-07-14' => '16:41', '2025-07-15' => '16:42', '2025-07-16' => '16:43',
    '2025-07-17' => '16:44', '2025-07-18' => '16:45', '2025-07-19' => '16:46', '2025-07-20' => '16:47',
    '2025-07-21' => '16:48', '2025-07-22' => '16:49', '2025-07-23' => '16:50', '2025-07-24' => '16:51',
    '2025-07-25' => '16:52', '2025-07-26' => '16:53', '2025-07-27' => '16:54', '2025-07-28' => '16:55',
    '2025-07-29' => '16:56', '2025-07-30' => '16:57', '2025-07-31' => '16:58',

    // AGOSTO 2025 - DADOS CHM OFICIAIS REAIS
    '2025-08-01' => '17:27', '2025-08-02' => '17:32', '2025-08-03' => '17:33', '2025-08-04' => '17:33',
    '2025-08-05' => '17:33', '2025-08-06' => '17:34', '2025-08-07' => '17:34', '2025-08-08' => '17:35',
    '2025-08-09' => '17:35', '2025-08-10' => '17:35', '2025-08-11' => '17:36', '2025-08-12' => '17:36',
    '2025-08-13' => '17:36', '2025-08-14' => '17:37', '2025-08-15' => '17:37', '2025-08-16' => '17:38',
    '2025-08-17' => '17:38', '2025-08-18' => '17:38', '2025-08-19' => '17:39', '2025-08-20' => '17:39',
    '2025-08-21' => '17:39', '2025-08-22' => '17:40', '2025-08-23' => '17:40', '2025-08-24' => '17:40',
    '2025-08-25' => '17:41', '2025-08-26' => '17:41', '2025-08-27' => '17:41', '2025-08-28' => '17:42',
    '2025-08-29' => '17:42', '2025-08-30' => '17:42', '2025-08-31' => '17:42',

    // SETEMBRO 2025 - DADOS CHM OFICIAIS REAIS
    '2025-09-01' => '17:43', '2025-09-02' => '17:43', '2025-09-03' => '17:44', '2025-09-04' => '17:44',
    '2025-09-05' => '17:44', '2025-09-06' => '17:44', '2025-09-07' => '17:45', '2025-09-08' => '17:45',
    '2025-09-09' => '17:45', '2025-09-10' => '17:45', '2025-09-11' => '17:46', '2025-09-12' => '17:46',
    '2025-09-13' => '17:46', '2025-09-14' => '17:47', '2025-09-15' => '17:47', '2025-09-16' => '17:47',
    '2025-09-17' => '17:48', '2025-09-18' => '17:48', '2025-09-19' => '17:48', '2025-09-20' => '17:48',
    '2025-09-21' => '17:49', '2025-09-22' => '17:49', '2025-09-23' => '17:49', '2025-09-24' => '17:50',
    '2025-09-25' => '17:50', '2025-09-26' => '17:50', '2025-09-27' => '17:51', '2025-09-28' => '17:51',
    '2025-09-29' => '17:51', '2025-09-30' => '17:52',

    // OUTUBRO 2025 - DADOS CHM OFICIAIS REAIS
    '2025-10-01' => '17:52', '2025-10-02' => '17:52', '2025-10-03' => '17:53', '2025-10-04' => '17:53',
    '2025-10-05' => '17:53', '2025-10-06' => '17:54', '2025-10-07' => '17:54', '2025-10-08' => '17:54',
    '2025-10-09' => '17:55', '2025-10-10' => '17:55', '2025-10-11' => '17:56', '2025-10-12' => '17:56',
    '2025-10-13' => '17:56', '2025-10-14' => '17:57', '2025-10-15' => '17:57', '2025-10-16' => '17:58',
    '2025-10-17' => '17:58', '2025-10-18' => '17:59', '2025-10-19' => '17:59', '2025-10-20' => '18:00',
    '2025-10-21' => '18:00', '2025-10-22' => '18:00', '2025-10-23' => '18:01', '2025-10-24' => '18:01',
    '2025-10-25' => '18:02', '2025-10-26' => '18:02', '2025-10-27' => '18:03', '2025-10-28' => '18:03',
    '2025-10-29' => '18:04', '2025-10-30' => '18:05', '2025-10-31' => '18:05',

    // NOVEMBRO 2025 - DADOS CHM OFICIAIS REAIS
    '2025-11-01' => '18:06', '2025-11-02' => '18:06', '2025-11-03' => '18:07', '2025-11-04' => '18:07',
    '2025-11-05' => '18:08', '2025-11-06' => '18:09', '2025-11-07' => '18:09', '2025-11-08' => '18:10',
    '2025-11-09' => '18:10', '2025-11-10' => '18:11', '2025-11-11' => '18:12', '2025-11-12' => '18:12',
    '2025-11-13' => '18:13', '2025-11-14' => '18:14', '2025-11-15' => '18:14', '2025-11-16' => '18:15',
    '2025-11-17' => '18:16', '2025-11-18' => '18:16', '2025-11-19' => '18:17', '2025-11-20' => '18:18',
    '2025-11-21' => '18:18', '2025-11-22' => '18:19', '2025-11-23' => '18:20', '2025-11-24' => '18:20',
    '2025-11-25' => '18:21', '2025-11-26' => '18:22', '2025-11-27' => '18:23', '2025-11-28' => '18:23',
    '2025-11-29' => '18:24', '2025-11-30' => '18:25',

    // DEZEMBRO 2025 - DADOS CHM OFICIAIS REAIS
    '2025-12-01' => '18:25', '2025-12-02' => '18:26', '2025-12-03' => '18:27', '2025-12-04' => '18:27',
    '2025-12-05' => '18:28', '2025-12-06' => '18:29', '2025-12-07' => '18:29', '2025-12-08' => '18:30',
    '2025-12-09' => '18:31', '2025-12-10' => '18:31', '2025-12-11' => '18:32', '2025-12-12' => '18:32',
    '2025-12-13' => '18:33', '2025-12-14' => '18:34', '2025-12-15' => '18:34', '2025-12-16' => '18:35',
    '2025-12-17' => '18:35', '2025-12-18' => '18:36', '2025-12-19' => '18:36', '2025-12-20' => '18:37',
    '2025-12-21' => '18:37', '2025-12-22' => '18:38', '2025-12-23' => '18:38', '2025-12-24' => '18:39',
    '2025-12-25' => '18:39', '2025-12-26' => '18:40', '2025-12-27' => '18:40', '2025-12-28' => '18:41',
    '2025-12-29' => '18:41', '2025-12-30' => '18:41', '2025-12-31' => '18:42'
];

try {
    $pdo->beginTransaction();
    
    $stmt = $pdo->prepare('
        INSERT INTO chm_horarios (data, por_do_sol, fonte, observacoes) 
        VALUES (?, ?, ?, ?) 
        ON CONFLICT (data) DO UPDATE SET 
        por_do_sol = EXCLUDED.por_do_sol,
        fonte = EXCLUDED.fonte,
        observacoes = EXCLUDED.observacoes,
        updated_at = CURRENT_TIMESTAMP
    ');
    
    $contador = 0;
    foreach ($sunsetData as $date => $time) {
        // Determinar se é dado oficial ou estimado
        $mesAno = substr($date, 0, 7); // YYYY-MM
        $isOficial = in_array($mesAno, ['2025-08', '2025-09', '2025-10', '2025-11', '2025-12']);
        
        $fonte = $isOficial ? 'CHM' : 'CHM_Estimado';
        $observacao = $isOficial ? 'Dados oficiais CHM' : 'Estimado baseado em padrão CHM';
        
        $stmt->execute([$date, $time, $fonte, $observacao]);
        $contador++;
        
        if ($contador % 50 == 0) {
            echo "Inseridos {$contador} registros...<br>";
        }
    }
    
    $pdo->commit();
    echo "✅ <strong>{$contador} registros inseridos/atualizados com sucesso!</strong><br><br>";
    
} catch (PDOException $e) {
    $pdo->rollBack();
    echo "❌ Erro ao inserir dados: " . $e->getMessage() . "<br>";
}

// PASSO 3: Verificar os dados inseridos
echo "<h2>PASSO 3: Verificando dados inseridos...</h2>";

try {
    $stmt = $pdo->query('SELECT COUNT(*) as total FROM chm_horarios');
    $total = $stmt->fetch()['total'];
    echo "📊 <strong>Total de registros na tabela:</strong> {$total}<br><br>";

    // Mostrar alguns exemplos
    echo "<h3>Exemplos de registros:</h3>";
    $stmt = $pdo->query('
        SELECT data, por_do_sol, fonte, observacoes 
        FROM chm_horarios 
        WHERE data IN (\'2025-01-01\', \'2025-09-25\', \'2025-12-31\')
        ORDER BY data
    ');
    
    echo "<table border='1' style='border-collapse: collapse; margin: 10px 0;'>";
    echo "<tr><th>Data</th><th>Pôr do Sol</th><th>Fonte</th><th>Observações</th></tr>";
    
    while ($row = $stmt->fetch()) {
        echo "<tr>";
        echo "<td>" . date('d/m/Y', strtotime($row['data'])) . "</td>";
        echo "<td><strong>" . $row['por_do_sol'] . "</strong></td>";
        echo "<td>" . $row['fonte'] . "</td>";
        echo "<td>" . $row['observacoes'] . "</td>";
        echo "</tr>";
    }
    echo "</table>";

    // Teste para hoje
    $hoje = date('Y-m-d');
    $stmt = $pdo->prepare('SELECT por_do_sol FROM chm_horarios WHERE data = ?');
    $stmt->execute([$hoje]);
    $horarioHoje = $stmt->fetchColumn();
    
    if ($horarioHoje) {
        echo "<h3>🌅 Teste: Pôr do sol hoje ({$hoje}): <strong>{$horarioHoje}</strong></h3>";
    }

} catch (PDOException $e) {
    echo "❌ Erro ao verificar dados: " . $e->getMessage() . "<br>";
}

echo "<h2>🎉 SETUP CONCLUÍDO!</h2>";
echo "<p><strong>Próximos passos:</strong></p>";
echo "<ol>";
echo "<li>Criar o arquivo <code>sunset_system_db.php</code> (vou enviar a seguir)</li>";
echo "<li>Modificar seu código principal para usar o novo sistema</li>";
echo "<li>Testar o funcionamento</li>";
echo "</ol>";
echo "<p><em>Você pode apagar este arquivo após a execução.</em></p>";
?>